{% load json_filters join_trial%}
{% if participating.count == 0 and running.count == 0 and usertrials.count == 0 %}
  <p>
    Looks like you haven't <a href="{% url 'trial-create' %}">created</a>
    or <a href="{% url 'trials' %}">joined</a> any trials yet!
  </p>
  <p>
    Can we suggest that you start with one of our trial templates? They're
    simple, fun, and designed to help you understand why we're so excited
    by randomised control trials in general, and by how much easier
    Randomise Me makes it to run them. (COMING SOON)
  </p>
{% else %}
    {% if usertrials.count > 0 or running.count > 0 %}
      <div class="row-fluid">
        <div class="span8 grey-back feature-box">
          <h3>
            <i class="icon-user red"></i>
            Trials you're running
          </h3>
        <table class="table table-striped table-bordered">
          <tr>
            <th>Name</th>
            <th>Dates</th>
            <th>Participant</th>
            <th>Datapoints</th>
            <th>Public?</th>
          </tr>
          {% for trial in running %}
            <tr>
              <td>
                <a href="{{ trial.get_absolute_url }}">
                  {{ trial.question }}
                </a>
              </td>
              <td>
                {{ trial.start_date }} - {{ trial.finish_date }}
              </td>
              <td>
                {{ trial.participant_set.count }}/{{ trial.min_participants }}
              </td>
              <td>
                {{ trial.report_set.count }}
              </td>
              <td>
                {% if trial.private %}
                  <i class="icon-lock red"></i>
                {% else %}
                  <i class="icon-unlock green"></i>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          {% for trial in usertrials %}
            <tr>
              <td>
                <a href="{{ trial.get_absolute_url }}">
                  {{ trial.question }}
                </a>
              </td>
              <td>
                {{ trial.start_date }} - {{ trial.finish_date }}
              </td>
              <td>1/1 (100%) </td>
              <td>
                {{ trial.singleuserreport_set.count }}
              </td>
              <td><i class="icon-lock red"></i></td>
            </tr>
          {% endfor %}
        </table>
        </div>
      </div>
    {% endif %}

    {% if participating.count > 0 %}
      <div class="row-fluid drop24">
        <div class="span8 grey-back feature-box">

          <h3>
            <i class="icon-group yellow"></i>
            Trials you're participating in
          </h3>

          <table class="table table-striped table-bordered">
            <tr>
              <th>Name</th>
              <th>Finish Date</th>
              <th>Data</th>
            </tr>
            {% for part in participating %}
            <tr>
              <td>
                <a href="{{ part.trial.get_absolute_url }}">
                  {{ part.trial.question }}
                </a>
              </td>
              <td>{{ part.trial.finish_date}}</td>
              <td>
                <a href="{{ part.trial.get_reporting_url}}" class="btn btn-danger">
                  Report data
                </a>
              </td>
            </tr>
            {% endfor %}
          </table>

        </div>
      </div>
    {% endif %}

    {% if completed.count > 0 %}
      <div class="row-fluid drop24">
        <div class="span8 grey-back feature-box">
          <h3>
            <i class="icon-user red"></i>
            Finished Trials
          </h3>

          <table class="table table-striped table-bordered">
            <tr>
              <th>Trial</th>
              <th>Description</th>
              <th>Results</th>
            </tr>
            {% for trial in completed %}
            <tr>
              <td>
                <a href="{{ trial.get_absolute_url }}">
                  {{ trial.question }}
                  </a>
              </td>
              <td>{{ trial.description }}</td>
              <td>
                <div id="vis{{trial.pk}}">

                </div><!--vis{{trial.pk}}-->
                <script type="text/javascript">
                  {% autoescape off %}
                  $(document).ready( function(){
                    RM.graphs.trial_thumbnail("#vis{{trial.pk}}", {{trial.results|json}} );
                    });
                  {% endautoescape %}
                </script>
              </td>
          {% endfor %}
            </tr>
          </table>
        </div>
      </div>
    {% endif %}

    {% if participated.count > 0 %}
      <div class="row-fluid drop24">
        <div class="span8 grey-back feature-box">
          <h3>
            <i class="icon-user red"></i>
            Trials you participated in
          </h3>

          <table class="table table-striped table-bordered">
            <tr>
              <th>Trial</th>
              <th>Description</th>
              <th>Results</th>
            </tr>
            {% for participant in participated %}
            {% with participant.trial as trial %}
            <tr>
              <td>
                <a href="{{ trial.get_absolute_url }}">
                  {{ trial.question }}
                  </a>
              </td>
              <td>{{ trial.description }}</td>
              <td>
                <div id="vis{{trial.pk}}">

                </div><!--vis{{trial.pk}}-->
                <script type="text/javascript">
                  {% autoescape off %}
                  $(document).ready( function(){
                    RM.graphs.trial_thumbnail("#vis{{trial.pk}}", {{trial.results|json}} );
                    });
                  {% endautoescape %}
                </script>
              </td>
              {% endwith %}
          {% endfor %}
            </tr>
          </table>
        </div>
      </div>
    {% endif %}


    <div class="row-fluid drop24">
      {% join_trial_widget %}
    </div>

{% endif %}
